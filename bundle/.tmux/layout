#!/bin/bash
# layout - Build a tmux pane layout from a JSON definition
#
# Usage: layout [json-file]
#
# Requires: jq
#
# Reads a JSON file describing panes and applies the layout to the current
# tmux window in two passes:
#
#   1. Create panes by splitting the window according to each pane's `split`
#      direction ("horizontal" or "vertical") and optional `size` (e.g. "20%").
#   2. Execute each pane's `commands` list in order (e.g. ["pwd", "ls -al"]).

set -euo pipefail

# --- Validation ---

if ! command -v jq &>/dev/null; then
  echo "Error: jq is required but not installed." >&2
  exit 1
fi

if [ -z "${TMUX:-}" ]; then
  echo "Error: Not inside a tmux session." >&2
  exit 1
fi

resolve_json_file() {
  if [ $# -ge 1 ]; then
    if [ ! -f "$1" ]; then
      echo "Error: File not found: $1" >&2
      exit 1
    fi
    echo "$1"
    return
  fi

  # Discover JSON files from known directories
  local files=()
  local paths=()

  for dir in "$HOME/.tmux" "./.tmux"; do
    for f in "$dir"/*.json; do
      [ -f "$f" ] || continue
      local resolved
      resolved=$(realpath "$f")
      local dup=0
      if [ ${#paths[@]} -gt 0 ]; then
        local k
        for k in "${paths[@]}"; do
          if [ "$k" = "$resolved" ]; then
            dup=1
            break
          fi
        done
      fi
      if [ "$dup" -eq 0 ]; then
        files+=("$f")
        paths+=("$resolved")
      fi
    done
  done

  if [ ${#files[@]} -eq 0 ]; then
    echo "Error: No JSON files found in ~/.tmux/ or ./.tmux/" >&2
    exit 1
  fi

  echo "" >&2
  echo "Available layout files:" >&2
  for i in "${!files[@]}"; do
    printf "  %d) %s\n" "$((i + 1))" "${files[$i]}" >&2
  done
  printf "  q) Cancel\n" >&2
  echo "" >&2

  local choice
  read -rp "Select: " choice < /dev/tty

  if [ "$choice" = "q" ]; then
    exit 0
  fi

  if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#files[@]} ]; then
    echo "Error: Invalid selection: $choice" >&2
    exit 1
  fi

  echo "${paths[$((choice - 1))]}"
}

JSON_FILE=$(resolve_json_file "$@")
PANE_COUNT=$(jq '.panes | length' "$JSON_FILE")

if [ "$PANE_COUNT" -eq 0 ]; then
  echo "Error: No panes defined in $JSON_FILE" >&2
  exit 1
fi

# --- Pass 1: Create panes ---

PANE_IDS=()

for ((i = 0; i < PANE_COUNT; i++)); do
  if [ "$i" -eq 0 ]; then
    # First pane is the current pane
    PANE_IDS+=($(tmux display-message -p '#{pane_id}'))
    continue
  fi

  SPLIT=$(jq -r ".panes[$i].split // \"vertical\"" "$JSON_FILE")
  SIZE=$(jq -r ".panes[$i].size // empty" "$JSON_FILE")

  # Split from the previously created pane to build a chained layout.
  CMD=(tmux split-window -t "${PANE_IDS[$((i - 1))]}" -P -F '#{pane_id}')

  if [ "$SPLIT" = "vertical" ]; then
    CMD+=(-h)
  elif [ "$SPLIT" = "horizontal" ]; then
    CMD+=(-v)
  else
    echo "Error: Invalid split for panes[$i]: $SPLIT (expected 'vertical' or 'horizontal')" >&2
    exit 1
  fi

  if [ -n "$SIZE" ]; then
    CMD+=(-l "$SIZE")
  fi

  PANE_IDS+=($("${CMD[@]}"))
done

# --- Pass 2: Send commands ---

for ((i = 0; i < PANE_COUNT; i++)); do
  CMD_COUNT=$(jq ".panes[$i].commands // [] | length" "$JSON_FILE")
  for ((j = 0; j < CMD_COUNT; j++)); do
    CMD=$(jq -r ".panes[$i].commands[$j]" "$JSON_FILE")
    tmux send-keys -t "${PANE_IDS[$i]}" "$CMD" C-m
  done
done
